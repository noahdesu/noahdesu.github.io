<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Remote RAM Disk With RDMA</title>
  <meta name="description" content="In this post I&#39;ll show you how to use iSER, iSCSI, and LIO to setup a remoteRAM disk. This is useful if you need high IOPS but don&#39;t have access to a...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://noahdesu.github.io/2015/01/08/rdma-ramdisk.html">
  <link rel="alternate" type="application/rss+xml" title="makedist" href="http://noahdesu.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">makedist</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
          <a class="page-link" href="/legion.html">Legion</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Remote RAM Disk With RDMA</h1>
    <p class="post-meta">Jan 8, 2015
    </p>
    <a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="noahdesu">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </header>

  <article class="post-content">
    <p>In this post I&#39;ll show you how to use iSER, iSCSI, and LIO to setup a remote
RAM disk. This is useful if you need high IOPS but don&#39;t have access to a
bunch of SSDs or NVRAM. Note that the performance achieved in this post is
quite low compared to what you should be able to achieve with different
hardware. Currently the arm64 machines we are using aren&#39;t getting the
performance expected, and tuning is on going. However, the description of the
steps here are relevant for other installations. Once you create several
remote RAM disks, tie them together with RAID 0 or dm-linear.</p>

<p>We&#39;ll use the following hardware provided by CloudLab.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">HP Moonshot m400
Eight 64-bit ARMv8 <span class="o">(</span>Atlas/A57<span class="o">)</span> cores at 2.4 GHz <span class="o">(</span>APM X-GENE<span class="o">)</span>
64GB ECC Memory <span class="o">(</span>8x <span class="m">8</span> GB DDR3-1600 SO-DIMMs<span class="o">)</span>
<span class="m">120</span> GB of flash <span class="o">(</span>SATA3 / M.2, Micron M500<span class="o">)</span>
Dual-port Mellanox ConnectX-3 <span class="m">10</span> GB NIC <span class="o">(</span>PCIe v3.0, <span class="m">8</span> lanes<span class="o">)</span></code></pre></figure>

<p>Next I&#39;ll show you the basic server and client setup, and then demonstrate
usage with some basic benchmarks.</p>

<h1>Target (Server) Setup</h1>

<p>Make the RAMDisk backing store:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/&gt; /backstores/rd_mcp create <span class="nv">name</span><span class="o">=</span>rd1 <span class="nv">size</span><span class="o">=</span>50G
Generating a wwn serial.
Created rd_mcp ramdisk rd1 with size 50G.</code></pre></figure>

<p>Make the iSCSI target:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/&gt; /iscsi create
Created target iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.385e783e5040.
Selected TPG Tag 1.
Successfully created TPG 1.</code></pre></figure>

<p>Create a LUN backed by the RAMDisk:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/&gt; iscsi/iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.385e783e5040/tpgt1/luns create <span class="nv">storage_object</span><span class="o">=</span>/backstores/rd_mcp/rd1 
Selected LUN 0.
Successfully created LUN 0.</code></pre></figure>

<p>Create a portal for the iSCSI target:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/&gt; iscsi/iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.385e783e5040/tpgt1/portals create 10.10.1.3
Using default IP port 3260
Successfully created network portal 10.10.1.3:3260.</code></pre></figure>

<p>Enable iSER on the portal:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/&gt; iscsi/iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.385e783e5040/tpgt1/portals/10.10.1.3:3260 iser_enable
iser operation has been enabled</code></pre></figure>

<p>Here is the final configuration</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/&gt; ls
o- / ..................................................................... <span class="o">[</span>...<span class="o">]</span>
  o- backstores .......................................................... <span class="o">[</span>...<span class="o">]</span>
  <span class="p">|</span> o- fileio ............................................... <span class="o">[</span><span class="m">0</span> Storage Object<span class="o">]</span>
  <span class="p">|</span> o- iblock ............................................... <span class="o">[</span><span class="m">0</span> Storage Object<span class="o">]</span>
  <span class="p">|</span> o- pscsi ................................................ <span class="o">[</span><span class="m">0</span> Storage Object<span class="o">]</span>
  <span class="p">|</span> o- rd_dr ................................................ <span class="o">[</span><span class="m">0</span> Storage Object<span class="o">]</span>
  <span class="p">|</span> o- rd_mcp ............................................... <span class="o">[</span><span class="m">1</span> Storage Object<span class="o">]</span>
  <span class="p">|</span>   o- rd1 ............................................... <span class="o">[</span>ramdisk activated<span class="o">]</span>
  o- ib_srpt ....................................................... <span class="o">[</span><span class="m">0</span> Targets<span class="o">]</span>
  o- iscsi .......................................................... <span class="o">[</span><span class="m">1</span> Target<span class="o">]</span>
  <span class="p">|</span> o- iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.385e783e5040 ...... <span class="o">[</span><span class="m">1</span> TPG<span class="o">]</span>
  <span class="p">|</span>   o- tpgt1 ....................................................... <span class="o">[</span>enabled<span class="o">]</span>
  <span class="p">|</span>     o- acls ....................................................... <span class="o">[</span><span class="m">0</span> ACLs<span class="o">]</span>
  <span class="p">|</span>     o- luns ........................................................ <span class="o">[</span><span class="m">1</span> LUN<span class="o">]</span>
  <span class="p">|</span>     <span class="p">|</span> o- lun0 ....................................... <span class="o">[</span>rd_mcp/rd1 <span class="o">(</span>ramdisk<span class="o">)]</span>
  <span class="p">|</span>     o- portals .................................................. <span class="o">[</span><span class="m">1</span> Portal<span class="o">]</span>
  <span class="p">|</span>       o- 10.10.1.3:3260 ................................. <span class="o">[</span>OK, iser enabled<span class="o">]</span>
  o- loopback ...................................................... <span class="o">[</span><span class="m">0</span> Targets<span class="o">]</span>
  o- qla2xxx ....................................................... <span class="o">[</span><span class="m">0</span> Targets<span class="o">]</span>
  o- tcm_fc ........................................................ <span class="o">[</span><span class="m">0</span> Targets<span class="o">]</span></code></pre></figure>

<p>Finally, disable all security</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/&gt; /iscsi/iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.385e783e5040/tpgt1/ <span class="nb">set </span>attribute <span class="nv">authentication</span><span class="o">=</span><span class="m">0</span> <span class="nv">demo_mode_write_protect</span><span class="o">=</span><span class="m">0</span> <span class="nv">generate_node_acls</span><span class="o">=</span><span class="m">1</span> <span class="nv">cache_dynamic_acls</span><span class="o">=</span>1
Parameter authentication is now <span class="s1">&#39;0&#39;</span>.
Parameter demo_mode_write_protect is now <span class="s1">&#39;0&#39;</span>.
Parameter generate_node_acls is now <span class="s1">&#39;1&#39;</span>.
Parameter cache_dynamic_acls is now <span class="s1">&#39;1&#39;</span>.</code></pre></figure>

<h1>Initiator (Client) Setup</h1>

<p>From the client, also called the initiator, we can use the <code>iscsiadm</code> tool to
look for the targets we have created. In this case we&#39;ve setup one iSCSI
target on the node with address <code>10.10.1.3</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo iscsiadm -m discovery -t sendtargets -p 10.10.1.3
10.10.1.3:3260,1 iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde</code></pre></figure>

<p>To access the iSCSI targets as local devices we need to <em>login</em> to the
targets. We can login to all of the targets that have been discovered with the
following command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo iscsiadm -m node -L all
Logging in to <span class="o">[</span>iface: default, target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde, portal: 10.10.1.3,3260<span class="o">]</span> <span class="o">(</span>multiple<span class="o">)</span>
Login to <span class="o">[</span>iface: default, target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde, portal: 10.10.1.3,3260<span class="o">]</span> successful.</code></pre></figure>

<p>Now that we have logged into the target, we should be able to access the LUN
we setup as a local device. We can see the device has been attached by
examining <code>dmesg</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span> 1653.685547<span class="o">]</span> scsi2 : iSCSI Initiator over TCP/IP
<span class="o">[</span> 1653.941126<span class="o">]</span> scsi 2:0:0:0: Direct-Access     LIO-ORG  RAMDISK-MCP      4.0  PQ: <span class="m">0</span> ANSI: 5
<span class="o">[</span> 1653.941314<span class="o">]</span> sd 2:0:0:0: Attached scsi generic sg1 <span class="nb">type </span>0
<span class="o">[</span> 1653.942324<span class="o">]</span> sd 2:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> <span class="m">104857600</span> 512-byte logical blocks: <span class="o">(</span>53.6 GB/50.0 GiB<span class="o">)</span>
<span class="o">[</span> 1653.942717<span class="o">]</span> sd 2:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Write Protect is off
<span class="o">[</span> 1653.942721<span class="o">]</span> sd 2:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Mode Sense: <span class="m">43</span> <span class="m">00</span> <span class="m">00</span> 08
<span class="o">[</span> 1653.942880<span class="o">]</span> sd 2:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Write cache: disabled, <span class="nb">read </span>cache: enabled, doesn<span class="err">&#39;</span>t support DPO or FUA
<span class="o">[</span> 1653.944324<span class="o">]</span>  sdb: unknown partition table
<span class="o">[</span> 1653.945174<span class="o">]</span> sd 2:0:0:0: <span class="o">[</span>sdb<span class="o">]</span> Attached SCSI disk</code></pre></figure>

<p>The <code>iscsiadm</code> tool also lets us look at a lot of information about the
targets. Using the following command we can see some of the networking
configuration for the targets:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo iscsiadm -m session -P 3
iSCSI Transport Class version 2.0-870
version 2.0-873
Target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde
        Current Portal: 10.10.1.3:3260,1
        Persistent Portal: 10.10.1.3:3260,1
                **********
                Interface:
                **********
                Iface Name: default
                Iface Transport: tcp
                Iface Initiatorname: iqn.1993-08.org.debian:01:a41f7afa2fc8
                Iface IPaddress: 10.10.1.1
                ...</code></pre></figure>

<p>Notice that the <code>Iface Transport</code> option is set to <code>tcp</code>. In order to get
maximum performance using RDMA, we want to use the iSER transport instead. To
set this we first need to logout of the targets:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo iscsiadm -m node -U all
Logging out of session <span class="o">[</span>sid: 1, target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde, portal: 10.10.1.3,3260<span class="o">]</span>
Logout of <span class="o">[</span>sid: 1, target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde, portal: 10.10.1.3,3260<span class="o">]</span> successful.</code></pre></figure>

<p>Next, set the <code>iface.transport_name</code> option to <code>iser</code> for our target:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo iscsiadm -m node -T iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde -o update -n iface.transport_name -v iser</code></pre></figure>

<p>Now we can log back in to the target and check to be sure that the transport
has been set to iSER. Login:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo iscsiadm -m node -L all
Logging in to <span class="o">[</span>iface: default, target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde, portal: 10.10.1.3,3260<span class="o">]</span> <span class="o">(</span>multiple<span class="o">)</span>
Login to <span class="o">[</span>iface: default, target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde, portal: 10.10.1.3,3260<span class="o">]</span> successful.</code></pre></figure>

<p>Check transport:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo iscsiadm -m session -P 3
iSCSI Transport Class version 2.0-870
version 2.0-873
Target: iqn.2003-01.org.linux-iscsi.node-1.aarch64:sn.e2d0d3a3bfde
        Current Portal: 10.10.1.3:3260,1
        Persistent Portal: 10.10.1.3:3260,1
                **********
                Interface:
                **********
                Iface Name: default
                Iface Transport: iser
                Iface Initiatorname: iqn.1993-08.org.debian:01:a41f7afa2fc8
                ...</code></pre></figure>

<p>Success!</p>

<h1>Benchmarks</h1>

<p>We are going to use the <code>fio</code> tool to do 512 byte direct I/O random reads and
writes to the remote RAM disk devices. With a single device we are able to get
around 70,000 random read and write IOPS. Here is the write workload:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randwrite --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --filename<span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb
asdf: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">1</span> process
^Cbs: <span class="m">1</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>1<span class="o">)</span>: <span class="o">[</span>w<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>0KB/34454KB/0KB /s<span class="o">]</span> <span class="o">[</span>0/68.1K/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:45m:24s<span class="o">]</span></code></pre></figure>

<p>And the read workload:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">inwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randread --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --filename<span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb
asdf: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">1</span> process
^Cobs: <span class="m">1</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>1<span class="o">)</span>: <span class="o">[</span>r<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>35481KB/0KB/0KB /s<span class="o">]</span> <span class="o">[</span>70.1K/0/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:45m:53s<span class="o">]</span>s<span class="o">]</span></code></pre></figure>

<p>I would expect the performance to be better.</p>

<h2>One iSCSI Target with 2 LUNs</h2>

<p>Next we try again with one iSCSI target hosting two LUNs, and instruct <code>fio</code>
to send IOs to both devices. For writes we get slightly less than 2x speed-up
at 113,000 IOPS:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randwrite --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --
<span class="nv">filename</span><span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb --filename<span class="o">=</span>/dev/sdc --name<span class="o">=</span>sdc
sdb: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdc: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">2</span> processes
^Cbs: <span class="m">2</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>3<span class="o">)</span>: <span class="o">[</span>ww<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>0KB/56665KB/0KB /s<span class="o">]</span> <span class="o">[</span>0/113K/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:46m:05s<span class="o">]</span></code></pre></figure>

<p>And right about 2x speed-up for reads:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randread --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --f
<span class="nv">ilename</span><span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb --filename<span class="o">=</span>/dev/sdc --name<span class="o">=</span>sdc                                                                                                                                                      
sdb: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdc: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">2</span> processes
^Cbs: <span class="m">2</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>3<span class="o">)</span>: <span class="o">[</span>rr<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>60537KB/0KB/0KB /s<span class="o">]</span> <span class="o">[</span>121K/0/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:46m:25s<span class="o">]</span></code></pre></figure>

<p>This still seems really slow.</p>

<h2>Two iSCSI portals With 2 LUNs</h2>

<p>Next we try to create separate portals. We associate one LUN with each portal.
Writes are now performing a bit better than 2x at 131K IOPS, but this is
probably a peak we caught. For the most part its about 2x:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randwrite --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --f
<span class="nv">ilename</span><span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb --filename<span class="o">=</span>/dev/sdc --name<span class="o">=</span>sdc                                                                                                                                                       
sdb: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdc: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">2</span> processes
^Cbs: <span class="m">2</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>3<span class="o">)</span>: <span class="o">[</span>ww<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>0KB/65281KB/0KB /s<span class="o">]</span> <span class="o">[</span>0/131K/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:45m:36s<span class="o">]</span> </code></pre></figure>

<p>And reads are a bit better too at 126K IOPS:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randread --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --fi
<span class="nv">lename</span><span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb --filename<span class="o">=</span>/dev/sdc --name<span class="o">=</span>sdc                                                                                                                                                        
sdb: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdc: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">2</span> processes
^Cbs: <span class="m">2</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>3<span class="o">)</span>: <span class="o">[</span>rr<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>63220KB/0KB/0KB /s<span class="o">]</span> <span class="o">[</span>126K/0/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:44m:26s<span class="o">]</span></code></pre></figure>

<p>Still not that great.</p>

<h2>Four Targets With Four LUNs</h2>

<p>The next experiment is four targets each with a separate LUN. Now we get
roughly 200K IOPS for read and write workloads. Write workload:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randwrite --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --f
<span class="nv">ilename</span><span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb --filename<span class="o">=</span>/dev/sdc --name<span class="o">=</span>sdc --filename<span class="o">=</span>/dev/sdd --name<span class="o">=</span>sdd --filename<span class="o">=</span>/dev/sde --name<span class="o">=</span>sde
sdb: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdc: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdd: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sde: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randwrite, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">4</span> processes
^Cbs: <span class="m">4</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>7<span class="o">)</span>: <span class="o">[</span>wwww<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>0KB/98105KB/0KB /s<span class="o">]</span> <span class="o">[</span>0/196K/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:44m:53s<span class="o">]</span></code></pre></figure>

<p>And the read workload:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nwatkins@node-0:~<span class="nv">$ </span>sudo fio --rw<span class="o">=</span>randread --bs<span class="o">=</span><span class="m">512</span> --numjobs<span class="o">=</span><span class="m">1</span> --iodepth<span class="o">=</span><span class="m">128</span> --runtime<span class="o">=</span><span class="m">9999999</span> --time_based --loops<span class="o">=</span><span class="m">1</span> --ioengine<span class="o">=</span>libaio --direct<span class="o">=</span><span class="m">1</span> --invalidate<span class="o">=</span><span class="m">1</span> --fsync_on_close<span class="o">=</span><span class="m">1</span> --norandommap --exitall --fi
<span class="nv">lename</span><span class="o">=</span>/dev/sdb --name<span class="o">=</span>sdb --filename<span class="o">=</span>/dev/sdc --name<span class="o">=</span>sdc --filename<span class="o">=</span>/dev/sdd --name<span class="o">=</span>sdd --filename<span class="o">=</span>/dev/sde --name<span class="o">=</span>sde                                                                                          
sdb: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdc: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sdd: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
sde: <span class="o">(</span><span class="nv">g</span><span class="o">=</span>0<span class="o">)</span>: <span class="nv">rw</span><span class="o">=</span>randread, <span class="nv">bs</span><span class="o">=</span>512-512/512-512/512-512, <span class="nv">ioengine</span><span class="o">=</span>libaio, <span class="nv">iodepth</span><span class="o">=</span>128
fio-2.1.3
Starting <span class="m">4</span> processes
^Cbs: <span class="m">4</span> <span class="o">(</span><span class="nv">f</span><span class="o">=</span>7<span class="o">)</span>: <span class="o">[</span>rrrr<span class="o">]</span> <span class="o">[</span>0.0% <span class="k">done</span><span class="o">]</span> <span class="o">[</span>98.11MB/0KB/0KB /s<span class="o">]</span> <span class="o">[</span>201K/0/0 iops<span class="o">]</span> <span class="o">[</span>eta 115d:17h:46m:13s<span class="o">]</span></code></pre></figure>

<p>I really expect much higher IOPS.</p>

<h2>Optimizations</h2>

<p>According to this page
<a href="https://vanity-mellanoxexternal.jiveon.com/docs/DOC-1483">https://vanity-mellanoxexternal.jiveon.com/docs/DOC-1483</a>
there are a lot of different optimizations that can be applied to help squeeze
out more performance. However, after applying most of the optimizations the
performance doesn&#39;t really improve for me. While the page above isn&#39;t using
RoCE and they are using x86 rather than arm64, they are able to get almost 2
million IOPS. I&#39;m hoping I can figure out how to get more IOPS out of our
setup.</p>

  </article>

  <section id="disqus_thread"></section>

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'noahdesugithubcom'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">makedist</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>makedist</li>
          <li><a href="mailto:noahwatkins@gmail.com">noahwatkins@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/noahdesu">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">noahdesu</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/noahdesu">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">noahdesu</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Notes on programming, research, and other interests.
</p>
      </div>
    </div>

  </div>

</footer>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37966177-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>

</html>
